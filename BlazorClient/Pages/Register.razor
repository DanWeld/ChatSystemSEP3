@page "/register"
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject ToastService ToastService
@attribute [AllowAnonymous]

<style>
    .auth-container {
        max-width: 400px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .form-field {
        margin-bottom: 1.5rem;
    }

    .form-field label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }

    .form-field input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .form-field input:focus {
        outline: none;
        border-color: #667eea;
    }

    .form-field .validation-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .form-field .field-description {
        color: #666;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .password-requirements {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 0.5rem;
        font-size: 0.875rem;
    }

    .password-requirements ul {
        margin: 0.5rem 0 0 0;
        padding-left: 1.5rem;
    }

    .password-requirements li {
        margin: 0.25rem 0;
        color: #666;
    }

    .password-requirements li.valid {
        color: #28a745;
    }

    .password-requirements li.invalid {
        color: #dc3545;
    }

    button[type="submit"] {
        width: 100%;
        padding: 0.875rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }

    button[type="submit"]:hover:not(:disabled) {
        transform: translateY(-2px);
    }

    button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .error {
        color: #dc3545;
        background: #f8d7da;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .success {
        color: #155724;
        background: #d4edda;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
</style>

<div class="auth-container">
    <h2>Create Account</h2>

    <EditForm Model="model" OnValidSubmit="HandleRegisterAsync">
        <DataAnnotationsValidator />
        
        <div class="form-field">
            <label for="username">Username</label>
            <InputText id="username" @bind-Value="model.Username" class="form-control" />
            <ValidationMessage For="@(() => model.Username)" />
            <div class="field-description">3-50 characters, letters, numbers, and underscores only</div>
        </div>

        <div class="form-field">
            <label for="password">Password</label>
            <InputText id="password" type="password" @bind-Value="model.Password" class="form-control" />
            <ValidationMessage For="@(() => model.Password)" />
            <div class="password-requirements">
                <strong>Password Requirements:</strong>
                <ul>
                    <li class="@(model.Password.Length >= 6 ? "valid" : "invalid")">
                        At least 6 characters
                    </li>
                    <li class="@(HasUppercase(model.Password) ? "valid" : "invalid")">
                        At least one uppercase letter
                    </li>
                    <li class="@(HasLowercase(model.Password) ? "valid" : "invalid")">
                        At least one lowercase letter
                    </li>
                    <li class="@(HasNumber(model.Password) ? "valid" : "invalid")">
                        At least one number
                    </li>
                </ul>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(error))
        {
            <div class="error">@error</div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="success">@successMessage</div>
        }

        <button type="submit" disabled="@(string.IsNullOrWhiteSpace(model.Username) || string.IsNullOrWhiteSpace(model.Password))">
            Register
        </button>
    </EditForm>

    <p style="text-align: center; margin-top: 1.5rem;">
        Already have an account?
        <a href="login">Sign in here</a>
    </p>
</div>

@code {
    private readonly RegisterRequest model = new();
    private string? error;
    private string? successMessage;

    private bool HasUppercase(string password) => !string.IsNullOrEmpty(password) && password.Any(char.IsUpper);
    private bool HasLowercase(string password) => !string.IsNullOrEmpty(password) && password.Any(char.IsLower);
    private bool HasNumber(string password) => !string.IsNullOrEmpty(password) && password.Any(char.IsDigit);

    private async Task HandleRegisterAsync()
    {
        error = null;
        successMessage = null;
        
        try
        {
            Console.WriteLine($"Registration attempt for username: {model.Username}");
            var success = await AuthService.RegisterAsync(model);
            if (success)
            {
                Console.WriteLine("Registration successful, navigating...");
                successMessage = "Registration successful! Redirecting...";
                ToastService.ShowSuccess("Account created successfully!");
                await Task.Delay(1000);
                Navigation.NavigateTo("/", true);
            }
            else
            {
                error = "Unable to register. The username may already be taken, or the server may not be running.";
                ToastService.ShowError(error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Registration exception: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            
            // Parse error message for better user feedback
            if (ex.Message.Contains("already taken") || ex.Message.Contains("AlreadyExists"))
            {
                error = "This username is already taken. Please choose a different username.";
            }
            else if (ex.Message.Contains("connect") || ex.Message.Contains("timeout"))
            {
                error = "Cannot connect to the server. Please ensure the server is running.";
            }
            else
            {
                error = $"Registration failed: {ex.Message}";
            }
            
            ToastService.ShowError(error);
        }
    }
}

