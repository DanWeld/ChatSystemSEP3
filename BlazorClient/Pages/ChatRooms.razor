@page "/"
@page "/chatrooms"
@attribute [Authorize]
@using BlazorClient.Shared
@inject HttpClient Http
@inject NavigationManager Navigation

<h2>Group Chats</h2>

<div class="chatrooms">
    <EditForm Model="createModel" OnValidSubmit="CreateRoomAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="create-room">
            <input @bind="createModel.Name" placeholder="New group name" />
        </div>
        <div class="create-room">
            <input @bind="createModel.Description" placeholder="Optional description" />
        </div>
        <button type="submit">Create Group Chat</button>
    </EditForm>

    @if (rooms.Count == 0)
    {
        <p>No group chats yet. Create one above!</p>
    }
    else
    {
        <ul>
            @foreach (var room in rooms)
            {
                <li>
                    <span>@room.Name</span>
                    <button @onclick="() => NavigateToRoom(room.Id)">Open</button>
                </li>
            }
        </ul>
    }

    @if (!string.IsNullOrEmpty(error))
    {
        <p class="error">@error</p>
    }
</div>

@code {
    private List<ChatRoomDto> rooms = new();
    private CreateGroupChatRequest createModel = new();
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoomsAsync();
    }

    private async Task LoadRoomsAsync()
    {
        try
        {
            error = null;
            // Load only group chats the current user is a member of
            rooms = await Http.GetFromJsonAsync<List<ChatRoomDto>>("api/groupchat/my-chats")
                ?? new List<ChatRoomDto>();
        }
        catch
        {
            error = "Unable to load group chats.";
            rooms = new List<ChatRoomDto>();
        }
    }

    private async Task CreateRoomAsync()
    {
        error = null;
        try
        {
            // Owner is taken from the JWT on the API side; MemberIds can be left empty.
            var response = await Http.PostAsJsonAsync("api/groupchat", createModel);
            if (response.IsSuccessStatusCode)
            {
                createModel = new CreateGroupChatRequest();
                await LoadRoomsAsync();
            }
            else
            {
                var content = await response.Content.ReadAsStringAsync();
                error = string.IsNullOrWhiteSpace(content)
                    ? "Unable to create group chat."
                    : $"Unable to create group chat: {content}";
            }
        }
        catch (Exception ex)
        {
            error = $"Unable to create group chat: {ex.Message}";
        }
    }

    private void NavigateToRoom(int roomId)
    {
        Navigation.NavigateTo($"/chat/{roomId}");
    }
}
